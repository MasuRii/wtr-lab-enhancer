// ==UserScript==
// @name WTR-Lab Reader & UI Enhancer
// @description Enhance your WTR-Lab reading experience with customizable reader width, navigation panel controls, and font styling options. Create the perfect reading environment on wtr-lab.com with this powerful userscript.
// @version 1.0.0
// @author MasuRii
// @supportURL https://github.com/MasuRii/wtr-lab-enhancer/issues
// @match https://wtr-lab.com/en/novel/*/*/chapter-*
// @connect gwfh.mranftl.com
// @connect fonts.googleapis.com
// @grant GM_addStyle
// @grant GM_getValue
// @grant GM_setValue
// @grant GM_registerMenuCommand
// @grant GM_xmlhttpRequest
// @homepageURL https://github.com/MasuRii/wtr-lab-enhancer
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @updateURL https://raw.githubusercontent.com/MasuRii/wtr-lab-enhancer/main/dist/wtr-lab-enhancer.user.js
// ==/UserScript==

(()=>{"use strict";var n={56:(n,e,t)=>{n.exports=function(n){var e=t.nc;e&&n.setAttribute("nonce",e)}},72:n=>{var e=[];function t(n){for(var t=-1,o=0;o<e.length;o++)if(e[o].identifier===n){t=o;break}return t}function o(n,o){for(var a={},i=[],l=0;l<n.length;l++){var s=n[l],c=o.base?s[0]+o.base:s[0],d=a[c]||0,p="".concat(c," ").concat(d);a[c]=d+1;var u=t(p),g={css:s[1],media:s[2],sourceMap:s[3],supports:s[4],layer:s[5]};if(-1!==u)e[u].references++,e[u].updater(g);else{var f=r(g,o);o.byIndex=l,e.splice(l,0,{identifier:p,updater:f,references:1})}i.push(p)}return i}function r(n,e){var t=e.domAPI(e);return t.update(n),function(e){if(e){if(e.css===n.css&&e.media===n.media&&e.sourceMap===n.sourceMap&&e.supports===n.supports&&e.layer===n.layer)return;t.update(n=e)}else t.remove()}}n.exports=function(n,r){var a=o(n=n||[],r=r||{});return function(n){n=n||[];for(var i=0;i<a.length;i++){var l=t(a[i]);e[l].references--}for(var s=o(n,r),c=0;c<a.length;c++){var d=t(a[c]);0===e[d].references&&(e[d].updater(),e.splice(d,1))}a=s}}},113:n=>{n.exports=function(n,e){if(e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},314:n=>{n.exports=function(n){var e=[];return e.toString=function(){return this.map(function(e){var t="",o=void 0!==e[5];return e[4]&&(t+="@supports (".concat(e[4],") {")),e[2]&&(t+="@media ".concat(e[2]," {")),o&&(t+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),t+=n(e),o&&(t+="}"),e[2]&&(t+="}"),e[4]&&(t+="}"),t}).join("")},e.i=function(n,t,o,r,a){"string"==typeof n&&(n=[[null,n,void 0]]);var i={};if(o)for(var l=0;l<this.length;l++){var s=this[l][0];null!=s&&(i[s]=!0)}for(var c=0;c<n.length;c++){var d=[].concat(n[c]);o&&i[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),e.push(d))}},e}},540:n=>{n.exports=function(n){var e=document.createElement("style");return n.setAttributes(e,n.attributes),n.insert(e,n.options),e}},601:n=>{n.exports=function(n){return n[1]}},659:n=>{var e={};n.exports=function(n,t){var o=function(n){if(void 0===e[n]){var t=document.querySelector(n);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(n){t=null}e[n]=t}return e[n]}(n);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(t)}},825:n=>{n.exports=function(n){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=n.insertStyleElement(n);return{update:function(t){!function(n,e,t){var o="";t.supports&&(o+="@supports (".concat(t.supports,") {")),t.media&&(o+="@media ".concat(t.media," {"));var r=void 0!==t.layer;r&&(o+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),o+=t.css,r&&(o+="}"),t.media&&(o+="}"),t.supports&&(o+="}");var a=t.sourceMap;a&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),e.styleTagTransform(o,n,e.options)}(e,n,t)},remove:function(){!function(n){if(null===n.parentNode)return!1;n.parentNode.removeChild(n)}(e)}}}},974:(n,e,t)=>{t.d(e,{A:()=>l});var o=t(601),r=t.n(o),a=t(314),i=t.n(a)()(r());i.push([n.id,'/* Modern CSS Design System with Fallbacks */\n:root {\n    /* Container Queries Support Detection */\n    --supports-container-queries: false;\n    \n    /* Design Tokens - Colors */\n    --panel-bg-primary: var(--bs-component-bg, #ffffff);\n    --panel-bg-secondary: var(--bs-tertiary-bg, #f8f9fa);\n    --panel-bg-elevated: var(--bs-body-bg, #ffffff);\n    --panel-text-primary: var(--bs-body-color, #212529);\n    --panel-text-secondary: var(--bs-secondary-color, #6c757d);\n    --panel-border: var(--bs-border-color, #dee2e6);\n    --panel-accent: var(--bs-primary, #0d6efd);\n    --panel-accent-hover: #0b5ed7;\n    --panel-success: #198754;\n    --panel-danger: #dc3545;\n    --panel-warning: #fd7e14;\n    \n    /* Design Tokens - Spacing */\n    --panel-spacing-xs: 0.25rem;\n    --panel-spacing-sm: 0.5rem;\n    --panel-spacing-md: 1rem;\n    --panel-spacing-lg: 1.5rem;\n    --panel-spacing-xl: 2rem;\n    \n    /* Design Tokens - Typography */\n    --panel-font-family: var(--bs-font-sans-serif, -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif);\n    --panel-font-size-xs: 0.75rem;\n    --panel-font-size-sm: 0.875rem;\n    --panel-font-size-md: 1rem;\n    --panel-font-size-lg: 1.125rem;\n    --panel-font-size-xl: 1.25rem;\n    --panel-font-weight-normal: 400;\n    --panel-font-weight-medium: 500;\n    --panel-font-weight-bold: 600;\n    --panel-line-height-tight: 1.2;\n    --panel-line-height-normal: 1.5;\n    --panel-line-height-relaxed: 1.75;\n    \n    /* Design Tokens - Border Radius */\n    --panel-radius-sm: var(--bs-border-radius-sm, 0.25rem);\n    --panel-radius-md: var(--bs-border-radius, 0.375rem);\n    --panel-radius-lg: var(--bs-border-radius-lg, 0.5rem);\n    --panel-radius-xl: 0.75rem;\n    --panel-radius-full: 9999px;\n    \n    /* Design Tokens - Shadows */\n    --panel-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);\n    --panel-shadow-md: 0 2px 4px rgba(0, 0, 0, 0.1);\n    --panel-shadow-lg: var(--bs-box-shadow-lg, 0 10px 15px -3px rgba(0, 0, 0, 0.1));\n    --panel-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);\n    \n    /* Design Tokens - Transitions */\n    --panel-transition-fast: 0.15s ease;\n    --panel-transition-normal: 0.3s ease;\n    --panel-transition-slow: 0.5s ease;\n    --panel-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n    \n    /* Design Tokens - Z-Index */\n    --panel-z-overlay: 9999;\n    --panel-z-panel: 10000;\n    --panel-z-tooltip: 10001;\n}\n\n/* Container Queries Support Detection */\n@supports (container-type: inline-size) {\n    :root {\n        --supports-container-queries: true;\n    }\n}\n\n/* Panel Container for Container Queries */\n#wtr-config-container {\n    container-name: wtr-panel;\n    container-type: inline-size;\n    container-index: 0;\n}\n\n/* Enhanced panel styling with design tokens */\n#wtr-config-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.7);\n    z-index: var(--panel-z-overlay);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    backdrop-filter: blur(4px);\n    contain: layout style paint;\n}\n\n#wtr-config-panel {\n    background: var(--panel-bg-primary);\n    color: var(--panel-text-primary);\n    padding: var(--panel-spacing-xl);\n    border-radius: var(--panel-radius-lg);\n    width: 90%;\n    max-width: 550px;\n    box-shadow: var(--panel-shadow-xl);\n    font-family: var(--panel-font-family);\n    display: flex;\n    flex-direction: column;\n    gap: var(--panel-spacing-lg);\n    max-height: 90vh;\n    border: 1px solid var(--panel-border);\n    \n    /* Performance optimizations */\n    contain: layout style paint;\n    will-change: transform, opacity;\n    transform: translateZ(0);\n}\n\n/* Enhanced Typography with Design Tokens */\n#wtr-config-panel h2 {\n    margin: 0;\n    text-align: center;\n    font-weight: var(--panel-font-weight-medium);\n    font-size: var(--panel-font-size-xl);\n    line-height: var(--panel-line-height-tight);\n    color: var(--panel-text-primary);\n    flex-shrink: 0;\n}\n\n/* Enhanced Sections with Containment */\n#wtr-config-panel #wtr-config-sections {\n    overflow-y: auto;\n    flex-grow: 1;\n    display: flex;\n    flex-direction: column;\n    gap: var(--panel-spacing-lg);\n    padding-right: var(--panel-spacing-md);\n    margin-right: calc(-1 * var(--panel-spacing-md));\n    \n    /* Performance optimization */\n    contain: layout style;\n}\n\n#wtr-config-panel .wtr-config-section {\n    display: flex;\n    flex-direction: column;\n    gap: var(--panel-spacing-lg);\n    padding: var(--panel-spacing-lg);\n    border: 1px solid var(--panel-border);\n    border-radius: var(--panel-radius-lg);\n    background: var(--panel-bg-secondary);\n    \n    /* Performance optimization */\n    contain: layout style paint;\n}\n\n#wtr-config-panel .wtr-control-group {\n    display: flex;\n    flex-direction: column;\n    gap: var(--panel-spacing-sm);\n}\n\n/* Modern Control Layout with Grid Fallback */\n#wtr-config-panel .wtr-config-controls {\n    display: flex;\n    gap: var(--panel-spacing-sm);\n    align-items: center;\n    flex-wrap: wrap;\n}\n\n#wtr-config-panel .wtr-config-controls.font-controls {\n    flex-wrap: nowrap;\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--panel-spacing-sm);\n}\n\n#wtr-config-panel .wtr-config-controls.checkbox-control {\n    justify-content: flex-start;\n    cursor: pointer;\n    padding: var(--panel-spacing-sm) 0;\n    display: grid;\n    grid-template-columns: auto 1fr;\n    gap: var(--panel-spacing-sm);\n    cursor: pointer;\n}\n\n#wtr-config-panel .wtr-config-controls.checkbox-control label {\n    user-select: none;\n}\n\n#wtr-config-panel .wtr-config-controls.checkbox-control input {\n    margin-right: var(--panel-spacing-sm);\n}\n\n/* Enhanced Form Controls with Touch Optimization */\n#wtr-config-panel input[type="number"],\n#wtr-config-panel select {\n    flex-grow: 1;\n    min-width: 100px;\n    min-height: 44px; /* Touch target size */\n    text-align: center;\n    background: var(--panel-bg-secondary);\n    color: var(--panel-text-primary);\n    border: 1px solid var(--panel-border);\n    border-radius: var(--panel-radius-md);\n    padding: var(--panel-spacing-sm) var(--panel-spacing-md);\n    font-family: var(--panel-font-family);\n    font-size: var(--panel-font-size-sm);\n    \n    /* Performance */\n    contain: layout style;\n}\n\n#wtr-config-panel select:disabled {\n    background: var(--panel-bg-secondary);\n    color: var(--panel-text-secondary);\n    cursor: not-allowed;\n}\n\n/* Modern Button Layout */\n#wtr-config-panel .wtr-button-group {\n    display: grid;\n    grid-auto-flow: column;\n    gap: var(--panel-spacing-sm);\n    justify-content: end;\n    flex-shrink: 0;\n}\n\n/* Enhanced Button Styling with Motion Controls */\n#wtr-config-panel .wtr-config-button {\n    min-height: 44px; /* iOS guideline */\n    min-width: 44px;\n    padding: var(--panel-spacing-sm) var(--panel-spacing-md);\n    border: none;\n    border-radius: var(--panel-radius-md);\n    cursor: pointer;\n    background-color: var(--panel-accent);\n    color: white;\n    font-weight: var(--panel-font-weight-bold);\n    font-size: var(--panel-font-size-sm);\n    flex-shrink: 0;\n    transition: background-color var(--panel-transition-fast),\n                transform var(--panel-transition-fast);\n    \n    /* Touch optimization */\n    touch-action: manipulation;\n    -webkit-tap-highlight-color: transparent;\n    \n    /* Performance */\n    contain: layout style paint;\n    will-change: transform;\n    transform: translateZ(0);\n}\n\n#wtr-config-panel .wtr-config-button:hover,\n#wtr-config-panel .wtr-config-button:focus-visible {\n    background-color: var(--panel-accent-hover);\n    transform: translateY(-1px);\n}\n\n#wtr-config-panel .wtr-config-button:active {\n    transform: translateY(0);\n}\n\n#wtr-config-panel .wtr-config-button:disabled {\n    background-color: var(--panel-text-secondary);\n    cursor: not-allowed;\n    transform: none;\n}\n\n#wtr-config-panel .wtr-config-button.control {\n    width: 44px;\n    aspect-ratio: 1;\n}\n\n#wtr-config-panel .wtr-config-button.reset {\n    background-color: var(--panel-danger);\n}\n\n#wtr-config-panel #wtr-config-close-btn {\n    background-color: var(--panel-text-secondary);\n    align-self: center;\n    width: 100px;\n    flex-shrink: 0;\n}\n\n/* Enhanced Typography */\n#wtr-config-panel .wtr-section-title {\n    font-weight: var(--panel-font-weight-medium);\n    text-align: center;\n    margin-bottom: var(--panel-spacing-sm);\n    display: block;\n    font-size: var(--panel-font-size-lg);\n    color: var(--panel-text-primary);\n}\n\n#wtr-config-panel .wtr-subsection-title {\n    font-weight: var(--panel-font-weight-medium);\n    text-align: left;\n    margin-top: var(--panel-spacing-lg);\n    display: block;\n    border-top: 1px solid var(--panel-border);\n    padding-top: var(--panel-spacing-lg);\n    color: var(--panel-text-primary);\n}\n\n/* Enhanced Button Hide Controls Layout */\n#wtr-config-panel .wtr-button-hide-controls {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: var(--panel-spacing-md);\n    justify-content: flex-start;\n}\n\n#wtr-config-panel .icon-checkbox label {\n    display: flex;\n    align-items: center;\n    gap: var(--panel-spacing-sm);\n}\n\n#wtr-config-panel .icon-checkbox svg {\n    width: 20px;\n    height: 20px;\n    stroke: currentColor;\n    fill: none;\n}\n\n#wtr-config-panel .icon-checkbox svg:has(use[href*="text_fields"], use[href*="tts"], use[href*="list"]) {\n    fill: currentColor;\n    stroke: none;\n}\n\n/* Motion Preference Handling - WCAG 2.2/2.3 Compliance */\n@media (prefers-reduced-motion: reduce) {\n    #wtr-config-overlay,\n    #wtr-config-panel,\n    .wtr-config-button {\n        transition: none !important;\n        animation: none !important;\n        transform: none !important;\n    }\n}\n\n/* Enable motion for users who haven\'t disabled it */\n@supports not (prefers-reduced-motion: reduce) {\n    #wtr-config-panel {\n        transition: transform var(--panel-transition-normal) var(--panel-timing-function),\n                   opacity var(--panel-transition-normal) ease;\n        transform: scale(0.95);\n    }\n    \n    #wtr-config-panel.visible {\n        transform: scale(1);\n    }\n}\n\n/* Container Query Responsive Design */\n@container wtr-panel (max-width: 480px) {\n    #wtr-config-panel {\n        width: 95%;\n        padding: var(--panel-spacing-lg);\n    }\n    \n    .wtr-config-controls {\n        flex-direction: column;\n        gap: var(--panel-spacing-xs);\n    }\n    \n    .wtr-config-controls.font-controls {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    .wtr-button-group {\n        margin-left: 0;\n        justify-content: center;\n        grid-auto-flow: row;\n    }\n    \n    .wtr-button-hide-controls {\n        grid-template-columns: 1fr;\n        gap: var(--panel-spacing-sm);\n    }\n}\n\n@container wtr-panel (max-width: 360px) {\n    #wtr-config-panel {\n        width: 98%;\n        margin: var(--panel-spacing-md);\n        padding: var(--panel-spacing-md);\n    }\n    \n    .wtr-config-section {\n        padding: var(--panel-spacing-md);\n    }\n    \n    .wtr-config-button {\n        min-width: 40px;\n    }\n}\n\n/* Grid Layout Fallbacks */\n@supports not (display: grid) {\n    .wtr-config-controls {\n        display: flex;\n        flex-wrap: wrap;\n    }\n    \n    .wtr-button-group {\n        display: flex;\n        flex-wrap: wrap;\n    }\n    \n    .wtr-button-hide-controls {\n        display: flex;\n        flex-wrap: wrap;\n    }\n}\n\n/* Container Queries Fallback */\n@supports not (container-type: inline-size) {\n    #wtr-config-container {\n        /* Fallback - styles remain as above for viewport-based responsiveness */\n    }\n    \n    /* Legacy media queries as fallback */\n    @media (max-width: 480px) {\n        #wtr-config-panel {\n            width: 95%;\n            padding: var(--panel-spacing-lg);\n        }\n        \n        .wtr-config-controls {\n            flex-direction: column;\n            gap: var(--panel-spacing-xs);\n        }\n    }\n}\n\n/* Backdrop Filter Fallback */\n@supports not (backdrop-filter: blur(1px)) {\n    #wtr-config-overlay {\n        background-color: rgba(0, 0, 0, 0.8);\n    }\n}\n\n/* Touch-specific enhancements */\n@media (hover: none) and (pointer: coarse) {\n    .wtr-config-button {\n        min-height: 48px;\n        padding: var(--panel-spacing-md) var(--panel-spacing-lg);\n        font-size: var(--panel-font-size-md);\n    }\n    \n    .wtr-config-controls input[type="number"],\n    .wtr-config-controls select {\n        min-height: 48px;\n        font-size: var(--panel-font-size-md);\n    }\n}',""]);const l=i}},e={};function t(o){var r=e[o];if(void 0!==r)return r.exports;var a=e[o]={id:o,exports:{}};return n[o](a,a.exports,t),a.exports}t.n=n=>{var e=n&&n.__esModule?()=>n.default:()=>n;return t.d(e,{a:e}),e},t.d=(n,e)=>{for(var o in e)t.o(e,o)&&!t.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:e[o]})},t.o=(n,e)=>Object.prototype.hasOwnProperty.call(n,e),t.nc=void 0;var o=t(72),r=t.n(o),a=t(825),i=t.n(a),l=t(659),s=t.n(l),c=t(56),d=t.n(c),p=t(540),u=t.n(p),g=t(113),f=t.n(g),m=t(974),b={};b.styleTagTransform=f(),b.setAttributes=d(),b.insert=s().bind(null,"head"),b.domAPI=i(),b.insertStyleElement=u(),r()(m.A,b),m.A&&m.A.locals&&m.A.locals;const v="wtr_lab_enhancer_debug",h={serif:["Merriweather","Lora","Crimson Text","Libre Baskerville","Spectral","EB Garamond","Noto Serif"],sansSerif:["Roboto","Open Sans","Source Sans Pro"]},w={reader:{key:"wtr_lab_reader_width",selector:".fix-size.card",defaultWidth:760,label:"Reader Content Width"},nav:{key:"wtr_lab_nav_width",selector:"nav.bottom-reader-nav .fix-size",defaultWidth:760,label:"Bottom Navigator Width"},navConstraint:{key:"wtr_lab_nav_constraint",selector:"nav.bottom-reader-nav",defaultState:!1,label:"Constrain Navigator Background"},fontToggle:{key:"wtr_lab_font_style_enabled",defaultState:!1,label:"Enable Custom Font Style"},font:{key:"wtr_lab_font_family",selector:".chapter-body",defaultFont:"Merriweather",label:"Font Style"},blockAddTerm:{key:"wtr_lab_block_add_term",selector:".floating-add-term-btn",defaultState:!1,label:'Block "Add Term" Button'},hideBookBtn:{key:"wtr_lab_hide_book_btn",selector:'div.btn-group button:has(svg use[href="/icons/sprite.svg#book"])',defaultState:!1,label:"Book",iconHTML:'<svg><use href="/icons/sprite.svg#book"></use></svg>'},hideTextFieldsBtn:{key:"wtr_lab_hide_text_fields_btn",selector:'div.btn-group button:has(svg use[href="/icons/sprite.svg#text_fields"])',defaultState:!1,label:"Text",iconHTML:'<svg><use href="/icons/sprite.svg#text_fields"></use></svg>'},hideTtsBtn:{key:"wtr_lab_hide_tts_btn",selector:'div.btn-group button:has(svg use[href="/icons/sprite.svg#tts"])',defaultState:!1,label:"TTS",iconHTML:'<svg><use href="/icons/sprite.svg#tts"></use></svg>'},hideCogBtn:{key:"wtr_lab_hide_cog_btn",selector:'div.btn-group button:has(svg use[href="/icons/sprite.svg#cog-outline"])',defaultState:!1,label:"Settings",iconHTML:'<svg><use href="/icons/sprite.svg#cog-outline"></use></svg>'},hideListBtn:{key:"wtr_lab_hide_list_btn",selector:'div.btn-group button:has(svg use[href="/icons/sprite.svg#list"])',defaultState:!1,label:"List",iconHTML:'<svg><use href="/icons/sprite.svg#list"></use></svg>'},debug:{key:v,defaultState:!1,label:"Enable Debug Logging"}};let y=GM_getValue(v,!1);const x=(...n)=>{y&&console.log("[WTR-Lab Enhancer]",...n)},k=(n,e)=>GM_getValue(n,e),E=(n,e)=>{const t=`custom-width-styler-${n}`;let o=document.getElementById(t);o||(o=document.createElement("style"),o.id=t,document.head.appendChild(o)),o.textContent=`${w[n].selector} { max-width: ${e}px !important; }`},S=()=>{const n=k(w.navConstraint.key,w.navConstraint.defaultState),e="custom-nav-constraint-styler";let t=document.getElementById(e);if(n){t||(t=document.createElement("style"),t.id=e,document.head.appendChild(t));const n=k(w.nav.key,w.nav.defaultWidth),o=Math.max(0,(window.innerWidth-n)/2);t.textContent=`${w.navConstraint.selector} { margin-left: ${o}px !important; margin-right: ${o}px !important; }`}else t&&t.remove()},T=()=>{const n=k(w.blockAddTerm.key,w.blockAddTerm.defaultState),e="custom-block-add-term-styler";let t=document.getElementById(e);n?(t||(t=document.createElement("style"),t.id=e,document.head.appendChild(t)),t.textContent=`${w.blockAddTerm.selector} { display: none !important; }`):t&&t.remove()},C=()=>{const n="custom-button-visibility-styler";let e=document.getElementById(n);const t=[w.hideBookBtn,w.hideTextFieldsBtn,w.hideTtsBtn,w.hideCogBtn,w.hideListBtn].filter(n=>k(n.key,n.defaultState)).map(n=>n.selector);!e&&t.length>0&&(e=document.createElement("style"),e.id=n,document.head.appendChild(e)),e&&(e.textContent=t.length>0?`${t.join(", ")} { display: none !important; }`:"")},_=(n,e)=>GM_getValue(n,e),B=()=>({recommendedSerif:h.serif,recommendedSansSerif:h.sansSerif,other:["Georgia","Times New Roman","Arial","Verdana"]}),L=()=>new Promise(n=>GM_xmlhttpRequest({method:"GET",url:"https://gwfh.mranftl.com/api/fonts",onload:e=>{try{const t=JSON.parse(e.responseText),o=[...h.serif,...h.sansSerif];n({recommendedSerif:h.serif,recommendedSansSerif:h.sansSerif,other:t.map(n=>n.family).filter(n=>!o.includes(n)).sort()})}catch(e){n(B())}},onerror:()=>n(B())})),M=n=>{if(!_(w.fontToggle.key,w.fontToggle.defaultState))return void(()=>{const n=document.getElementById("custom-font-styler");n&&n.remove();const e=document.getElementById("userscript-font-link");e&&e.remove()})();x(`Applying font: ${n}`);const e=n.split(",")[0].trim(),t="custom-font-styler";let o=document.getElementById(t);o||(o=document.createElement("style"),o.id=t,document.head.appendChild(o));const r=`https://fonts.googleapis.com/css2?family=${encodeURIComponent(e)}&display=swap`;let a=document.getElementById("userscript-font-link");a||(a=document.createElement("link"),a.id="userscript-font-link",a.rel="stylesheet",document.head.appendChild(a)),a.href=r,o.textContent=`${w.font.selector} { font-family: "${e}", serif, sans-serif !important; }`},I=async(n=null)=>{const e=document.getElementById("wtr-font-select");if(!e)return;const t=_(w.font.key,w.font.defaultFont);e.innerHTML="";const o=n||await L(),r={recommendedSerif:"Recommended (Serif)",recommendedSansSerif:"Recommended (Sans-serif)",other:"All Other Fonts"};for(const n in o){if(0===o[n].length)continue;const t=document.createElement("optgroup");t.label=r[n]||"Fonts",o[n].forEach(n=>{const e=document.createElement("option");e.value=n,e.textContent=n,t.appendChild(e)}),e.appendChild(t)}e.value=Object.values(o).flat().includes(t)?t:w.font.defaultFont},z=(n,e)=>GM_setValue(n,e),A=(n,e)=>GM_getValue(n,e);let F=GM_getValue(w.debug.key,!1);const $=n=>{["wtr-font-select","wtr-font-refresh-btn","wtr-font-reset-btn"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!n)})},D=()=>{for(const[n,e]of Object.entries(w))if("font"===n)document.getElementById("wtr-font-select").value=A(e.key,e.defaultFont);else if("fontToggle"===n){const n=A(e.key,e.defaultState);document.getElementById("wtr-fontToggle-toggle").checked=n,$(n)}else if(["navConstraint","blockAddTerm","debug"].includes(n)||n.startsWith("hide")){const t=document.getElementById(`wtr-${n}-toggle`);t&&(t.checked=A(e.key,e.defaultState))}else["reader","nav"].includes(n)&&(document.getElementById(`wtr-${n}-width-input`).value=A(e.key,e.defaultWidth));document.getElementById("wtr-config-overlay").style.display="flex"},G=()=>document.getElementById("wtr-config-overlay").style.display="none",R=()=>{const n=document.getElementById("wtr-config-container");n&&n.classList.add("wtr-container-responsive")},H=()=>{document.querySelectorAll(".wtr-config-controls").forEach(n=>{n.classList.add("wtr-grid-enabled")})},j=()=>{const n=document.getElementById("wtr-config-overlay");n&&n.classList.add("wtr-backdrop-filter")},P=()=>{document.querySelectorAll(".wtr-config-button").forEach(n=>{n.classList.add("wtr-touch-optimized")}),document.querySelectorAll('input[type="number"], select').forEach(n=>{n.classList.add("wtr-touch-optimized")})},W=(n,e)=>GM_getValue(n,e);(async()=>{x("Initializing script..."),y=GM_getValue(v,!1),(()=>{document.body.insertAdjacentHTML("beforeend",'<div id="wtr-config-container" class="wtr-panel-container"><div id="wtr-config-overlay" style="display: none;"><div id="wtr-config-panel"><h2>WTR-Lab Enhancer Settings</h2><div id="wtr-config-sections"></div><button id="wtr-config-close-btn" class="wtr-config-button">Close</button></div></div></div>');const n=document.getElementById("wtr-config-sections"),e=document.createElement("div");e.className="wtr-config-section",e.innerHTML=`<label class="wtr-section-title">Layout & Sizing</label>\n            <div class="wtr-control-group">\n                <label for="wtr-reader-width-input">${w.reader.label} (px)</label>\n                <div class="wtr-config-controls"><button id="wtr-reader-decrease-btn" class="wtr-config-button control">-</button><input type="number" id="wtr-reader-width-input" min="300" step="10"><button id="wtr-reader-increase-btn" class="wtr-config-button control">+</button><button id="wtr-reader-reset-btn" class="wtr-config-button reset">Reset</button></div>\n            </div>\n            <div class="wtr-control-group">\n                <label for="wtr-nav-width-input">${w.nav.label} (px)</label>\n                <div class="wtr-config-controls"><button id="wtr-nav-decrease-btn" class="wtr-config-button control">-</button><input type="number" id="wtr-nav-width-input" min="300" step="10"><button id="wtr-nav-increase-btn" class="wtr-config-button control">+</button><button id="wtr-nav-reset-btn" class="wtr-config-button reset">Reset</button></div>\n            </div>`,n.appendChild(e);const t=document.createElement("div");t.className="wtr-config-section",t.innerHTML=`<label class="wtr-section-title">Font Customization</label>\n            <div class="wtr-config-controls checkbox-control"><input type="checkbox" id="wtr-fontToggle-toggle"><label for="wtr-fontToggle-toggle">${w.fontToggle.label}</label></div>\n            <div class="wtr-control-group">\n                <label for="wtr-font-select">${w.font.label}</label>\n                <div class="wtr-config-controls font-controls"><select id="wtr-font-select"></select></div>\n                <div class="wtr-config-controls font-controls"><div class="wtr-button-group"><button id="wtr-font-refresh-btn" class="wtr-config-button">Refresh</button><button id="wtr-font-reset-btn" class="wtr-config-button reset">Reset</button></div></div>\n            </div>`,n.appendChild(t);const o=document.createElement("div");o.className="wtr-config-section",o.innerHTML=`<label class="wtr-section-title">Element Visibility</label>\n            <div class="wtr-config-controls checkbox-control"><input type="checkbox" id="wtr-navConstraint-toggle"><label for="wtr-navConstraint-toggle">${w.navConstraint.label}</label></div>\n            <div class="wtr-config-controls checkbox-control"><input type="checkbox" id="wtr-blockAddTerm-toggle"><label for="wtr-blockAddTerm-toggle">${w.blockAddTerm.label}</label></div>\n            <div class="wtr-control-group"><label class="wtr-subsection-title">Hide Toolbar Buttons</label><div class="wtr-button-hide-controls"></div></div>`;const r=o.querySelector(".wtr-button-hide-controls");Object.entries(w).filter(([n])=>n.startsWith("hide")).forEach(([n,e])=>{r.insertAdjacentHTML("beforeend",`<div class="wtr-config-controls checkbox-control icon-checkbox"><input type="checkbox" id="wtr-${n}-toggle"><label for="wtr-${n}-toggle">${e.iconHTML}<span>${e.label}</span></label></div>`)}),n.appendChild(o);const a=document.createElement("div");a.className="wtr-config-section",a.innerHTML='<label class="wtr-section-title">Debug & Advanced</label>\n\t\t\t         <div class="wtr-config-controls checkbox-control"><input type="checkbox" id="wtr-debug-toggle"><label for="wtr-debug-toggle">Enable Debug Logging</label></div>',n.appendChild(a),I(B()),(()=>{document.getElementById("wtr-config-overlay").addEventListener("click",n=>{"wtr-config-overlay"===n.target.id&&G()}),document.getElementById("wtr-config-close-btn").addEventListener("click",G);const n=(n,e)=>{const t=w[n];if(z(t.key,e),"font"===n)M(e),document.getElementById("wtr-font-select").value=e;else if("fontToggle"===n)$(e),M(A(w.font.key,w.font.defaultFont));else if("debug"===n)F=e,GM_setValue(v,F),x("Debug logging "+(F?"ENABLED":"DISABLED"));else if("navConstraint"===n)S();else if("blockAddTerm"===n)T();else if(n.startsWith("hide"))C();else{const o=Math.max(300,parseInt(e,10));if(isNaN(o))return;E(n,o),document.getElementById(`wtr-${n}-width-input`).value=o,z(t.key,o),"nav"===n&&S()}};for(const[e,t]of Object.entries(w))if("font"===e){const o=document.getElementById("wtr-font-select");o.addEventListener("change",()=>n(e,o.value)),document.getElementById("wtr-font-reset-btn").addEventListener("click",()=>n(e,t.defaultFont));const r=document.getElementById("wtr-font-refresh-btn");r.addEventListener("click",async()=>{r.textContent="Fetching...",r.disabled=!0,await I(),r.textContent="Refresh",r.disabled=!1})}else if(["fontToggle","navConstraint","blockAddTerm","debug"].includes(e)||e.startsWith("hide")){const t=document.getElementById(`wtr-${e}-toggle`);t&&t.addEventListener("change",()=>n(e,t.checked))}else if(["reader","nav"].includes(e)){const o=document.getElementById(`wtr-${e}-width-input`);document.getElementById(`wtr-${e}-increase-btn`).addEventListener("click",()=>n(e,parseInt(o.value,10)+50)),document.getElementById(`wtr-${e}-decrease-btn`).addEventListener("click",()=>n(e,parseInt(o.value,10)-50)),document.getElementById(`wtr-${e}-reset-btn`).addEventListener("click",()=>n(e,t.defaultWidth)),o.addEventListener("change",()=>n(e,o.value))}})()})(),E("reader",W(w.reader.key,w.reader.defaultWidth)),E("nav",W(w.nav.key,w.nav.defaultWidth)),S(),T(),C();const n=await L(),e=Object.values(n).flat();let t=W(w.font.key,w.font.defaultFont);var o;e.includes(t)||(t=w.font.defaultFont,o=w.font.key,GM_setValue(o,t)),M(t),I(n),window.addEventListener("resize",S),GM_registerMenuCommand("Configure Settings",D),(()=>{const n=(()=>{const n={containerQueries:CSS.supports("container-type: inline-size"),grid:CSS.supports("display: grid"),backdropFilter:CSS.supports("backdrop-filter: blur(1px)"),customProperties:CSS.supports("--custom: 0"),motionPreferences:window.matchMedia("(prefers-reduced-motion: reduce)"),touchDevice:"ontouchstart"in window||navigator.maxTouchPoints>0,reducedMotion:window.matchMedia("(prefers-reduced-motion: reduce)").matches};return x("CSS Feature Detection:",n),n})();document.documentElement.setAttribute("data-container-queries",n.containerQueries),document.documentElement.setAttribute("data-grid",n.grid),document.documentElement.setAttribute("data-backdrop-filter",n.backdropFilter),document.documentElement.setAttribute("data-touch-device",n.touchDevice),n.containerQueries&&(x("Container queries supported - enabling responsive container design"),R()),n.grid&&(x("CSS Grid supported - enabling modern grid layouts"),H()),n.backdropFilter&&(x("Backdrop filter supported - enabling blur effects"),j()),n.touchDevice&&(x("Touch device detected - optimizing for touch interactions"),P()),n.motionPreferences.addEventListener("change",n=>{const e=n.matches;document.documentElement.setAttribute("data-reduced-motion",e),x("Motion preference changed: "+(e?"Reduce motion":"Allow motion"))}),document.documentElement.setAttribute("data-reduced-motion",n.reducedMotion)})(),x("Initialization complete.")})()})();